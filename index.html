<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Shadowsocks Config Generator</title>
    <!-- Bootstrap core CSS -->
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container">
        <div class="py-5 text-center">
            <h2>Shadowsocks Config Generator</h2>
            <p class="lead">a simple tool for generating URL and QRcode of Shadowsocks and ShadowsocksR client configurations.</p>
        </div>
        <div class="d-block my-3">
            <div class="custom-control custom-radio">
                <input id="ss" name="ssType" type="radio" class="custom-control-input" checked required>
                <label class="custom-control-label" for="ss">Shadowsocks</label>
            </div>
            <div class="custom-control custom-radio">
                <input id="ssr" name="ssType" type="radio" class="custom-control-input" required>
                <label class="custom-control-label" for="ssr">ShadowsocksR</label>
            </div>
        </div>
        <hr class="mb-4">
        <!-- Test Button -->
        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-success btn-lg btn-block" id="testBtn" type="button">Test Data</button>
            </div>
        </div>
        <hr class="mb-4">
        <div class="row">
            <div class="col-md-12">
                <h4 class="mb-3">Parameters</h4>
                <form class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="server">Server *</label>
                            <input type="text" class="form-control" id="server" placeholder="127.0.0.1/example.com">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="serverPort">Server Port *</label>
                            <input type="text" class="form-control" id="serverPort" placeholder="443">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="password">Password *</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="method">Method *</label>
                            <select class="form-control" id="method">
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="localPort">Local Port</label>
                            <input type="text" class="form-control" id="localPort" placeholder="" value="1080">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="stimeout">Timeout</label>
                            <input type="text" class="form-control" id="stimeout" placeholder="" value="600">
                        </div>
                    </div>
                    <div class="row ssr-only">
                        <div class="col-md-6 mb-3">
                            <label for="protocol">Protocol *</label>
                            <select class="form-control" id="protocol">
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="protoparam">Protocol Params</label>
                            <input type="text" class="form-control" id="protoparam">
                        </div>
                    </div>
                    <div class="row ssr-only">
                        <div class="col-md-6 mb-3">
                            <label for="obfs">Obfs *</label>
                            <select class="form-control" id="obfs">
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="obfsparam">Obfs Params</label>
                            <input type="text" class="form-control" id="obfsparam">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3 ssr-only">
                            <label for="group">Group</label>
                            <input type="text" class="form-control" id="group" placeholder="default" value="">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="remarks">Remarks(Tag)</label>
                            <input type="text" class="form-control" id="remarks">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="size">QRcode Size</label>
                            <input type="text" class="form-control" id="size" placeholder="400" value="">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-primary btn-lg btn-block" id="generateBtn" type="button">Generate</button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-danger btn-lg btn-block" id="clearBtn" type="button">Clear</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <hr class="mb-4">
        <h4 class="mb-3">Results</h4>
        <div class="row">
            <div class="col-md-12">
                <label for="url">URL</label>
                <textarea type="text" class="form-control" rows="3" disabled id="url"></textarea>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <label>QRcode</label>
                <div align="center" id="qrcode">
                </div>
            </div>
        </div>
        <footer class="my-5 pt-5 text-muted text-center text-small">
            <p class="mb-1">&copy; 2018-2019 Zhiyuan Ling</p>
        </footer>
    </div>
    <script src="lib/jquery-3.3.1.slim.min.js"></script>
    <script src="lib/bootstrap/js/bootstrap.min.js"></script>
    <script src="lib/base64.min.js"></script>
    <script src="lib/qrcode.min.js"></script>
    <script src="ss.js"></script>
    <script src="gen.js"></script>
    <script type="text/javascript">
    const DEFAULT_QR_SIZE = 400;

    $(function() {

        // add method options
        METHODS.forEach(function(element) {
            $('#method')
                .append($("<option></option>")
                    .attr("value", element)
                    .text(element));
        });

        // add protocol options
        PROTOCOLS.forEach(function(element) {
            $('#protocol')
                .append($("<option></option>")
                    .attr("value", element)
                    .text(element));
        });

        // add obfs options
        OBFSES.forEach(function(element) {
            $('#obfs')
                .append($("<option></option>")
                    .attr("value", element)
                    .text(element));
        });

        // set ss type button actions
        $("input[name='ssType']").change(function() {
            let ssrChecked = $("#ssr:checked").val();
            if (ssrChecked) {
                ssrChecked = true;
                $(".ssr-only").show();
            } else {
                ssrChecked = false;
                $(".ssr-only").hide();
            }

            // store statuses
            localStorage.setItem("ssrChecked", ssrChecked);
        })

        // for testing purpose remove later
        $("#testBtn").click(function() {
            $("#server").val("127.0.0.1");
            $("#serverPort").val(1234);
            $("#password").val("test123");
            $("#method").val("aes-256-cfb");
            $("#localPort").val(1080);
            $("#stimeout").val(600);
            $("#protocol").val("origin");
            $("#protoparam").val(null);
            $("#obfs").val("plain");
            $("#obfsparam").val(null);
            $("#group").val("default");
            $("#remarks").val("test-ac");
        });

        // restore all the fields to default
        $("#clearBtn").click(function() {
            $("#server").val("");
            $("#serverPort").val("");
            $("#password").val("");
            $("#method").val(METHODS[0]);
            $("#localPort").val(1080);
            $("#stimeout").val(600);
            $("#protocol").val(PROTOCOLS[0]);
            $("#protoparam").val("");
            $("#obfs").val(OBFSES[0]);
            $("#obfsparam").val("");
            $("#group").val("");
            $("#remarks").val("");
            $("#url").val("");
            $("#qrcode").html("");
        })

        let qrcode = null;

        $("#generateBtn").on('click', function() {
            // retrieve values
            let server = $("#server").val();
            let server_port = $("#serverPort").val();
            let password = $("#password").val();
            let method = $("#method").val();
            let localPort = $("#localPort").val();
            let stimeout = $("#stimeout").val();
            let protocol = $("#protocol").val();
            let protoparam = $("#protoparam").val();
            let obfs = $("#obfs").val();
            let obfsparam = $("#obfsparam").val();
            let group = $("#group").val();
            let remarks = $("#remarks").val();
            let size = $("#size").val();

            // validate size, default size as the fallback value
            if (size == null || size == "" || isNaN(size)) {
                // not a number
                size = DEFAULT_QR_SIZE;
            }

            // construct new config
            const config = new Config(server, server_port, password, method, obfs, protocol, group, remarks, obfsparam, protoparam, localPort, stimeout);
            let result = "";
            if ($("#ss:checked").val()) {
                result = genSSConfig(config);;
            }

            if ($("#ssr:checked").val()) {
                result = genSSRConfig(config);
            }

            // display encoded URL
            $("#url").val(result);

            // clear previous code
            $("#qrcode").html("");

            // build qrcode and display as an image
            qrcode = new QRCode("qrcode", {
                text: result,
                width: size,
                height: size,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            localStorage.setItem("config", JSON.stringify(config));
            localStorage.setItem("size", JSON.stringify(size));

        });

        // restore previous settings status

        // restore ss type status
        // check localStorage first, if no item is found, check current status
        let ssrChecked = JSON.parse(localStorage.getItem("ssrChecked"));
        if (ssrChecked == null) {
            ssrChecked = $("#ssr:checked").val();
        } else {
            $("#ssr").prop('checked', ssrChecked);
        }

        if (ssrChecked) {
            $(".ssr-only").show();
        } else {
            $(".ssr-only").hide();
        }

        // restore qrcode size
        const size = JSON.parse(localStorage.getItem("size"));
        if (size != null) {
            $("#size").val(size);
        }

        // restore config
        const config = JSON.parse(localStorage.getItem("config"));
        if (config != null) {
            $("#server").val(config.server);
            $("#serverPort").val(config.server_port);
            $("#password").val(config.password);
            $("#method").val(config.method);
            $("#localPort").val(config.local_port);
            $("#stimeout").val(config.stimeout);
            $("#protocol").val(config.protocol);
            $("#protoparam").val(config.protoparam);
            $("#obfs").val(config.obfs);
            $("#obfsparam").val(config.obfsparam);
            $("#group").val(config.group);
            $("#remarks").val(config.remarks);
        }
    });
    </script>
</body>

</html>